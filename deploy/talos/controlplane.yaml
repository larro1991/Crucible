# Talos Linux Control Plane Configuration
# For Intuitive OS / Forge Stack
#
# This configures a Talos node as a control plane with our AI stack
# Talos is API-driven, immutable, and secure by default

version: v1alpha1
debug: false
persist: true

machine:
  type: controlplane
  token: ${MACHINE_TOKEN}  # Generated during deployment

  certSANs:
    - ${CONTROL_PLANE_IP}
    - ${CONTROL_PLANE_HOSTNAME}

  kubelet:
    image: ghcr.io/siderolabs/kubelet:v1.29.0
    extraArgs:
      feature-gates: GracefulNodeShutdown=true
    extraMounts:
      # Mount for EMBER shared memory
      - destination: /var/ember
        type: bind
        source: /var/ember
        options:
          - rbind
          - rw
      # Mount for Crucible data
      - destination: /var/crucible
        type: bind
        source: /var/crucible
        options:
          - rbind
          - rw

  network:
    hostname: ${HOSTNAME}
    interfaces:
      - interface: eth0
        dhcp: true
        # For static IP deployments:
        # addresses:
        #   - ${STATIC_IP}/24
        # routes:
        #   - network: 0.0.0.0/0
        #     gateway: ${GATEWAY_IP}
    nameservers:
      - 8.8.8.8
      - 8.8.4.4

  install:
    disk: /dev/sda
    image: ghcr.io/siderolabs/installer:v1.6.0
    bootloader: true
    wipe: false
    extensions:
      # NVIDIA GPU support (for GPU nodes)
      # - image: ghcr.io/siderolabs/nvidia-container-toolkit:v1.14.0
      # Intel GPU support
      # - image: ghcr.io/siderolabs/intel-gpu-firmware:v1.0.0

  sysctls:
    # Network tuning for high-throughput AI workloads
    net.core.somaxconn: "65535"
    net.core.netdev_max_backlog: "65535"
    net.ipv4.tcp_max_syn_backlog: "65535"
    net.ipv4.ip_local_port_range: "1024 65535"
    # Memory tuning
    vm.swappiness: "10"
    vm.dirty_ratio: "60"
    vm.dirty_background_ratio: "2"

  files:
    # Core Principles - Always present on every node
    - content: |
        HONESTY=true
        KINDNESS=true
        TRUST=true
        TRANSPARENCY=true
      permissions: 0644
      path: /etc/ember/principles
      op: create

    # Forge configuration
    - content: |
        FORGE_MODE=controller
        EMBER_ENABLED=true
        CINDER_ENABLED=true
        CRUCIBLE_ENABLED=true
        LOG_LEVEL=info
      permissions: 0644
      path: /etc/forge/config
      op: create

cluster:
  id: ${CLUSTER_ID}
  secret: ${CLUSTER_SECRET}

  controlPlane:
    endpoint: https://${CONTROL_PLANE_ENDPOINT}:6443

  clusterName: intuitive-os

  network:
    cni:
      name: flannel
    dnsDomain: cluster.local
    podSubnets:
      - 10.244.0.0/16
    serviceSubnets:
      - 10.96.0.0/12

  apiServer:
    certSANs:
      - ${CONTROL_PLANE_IP}
      - ${CONTROL_PLANE_HOSTNAME}
    extraArgs:
      # Enable auditing
      audit-log-path: /var/log/kubernetes/audit.log
      audit-log-maxage: "30"
      audit-log-maxbackup: "10"
      audit-log-maxsize: "100"

  controllerManager:
    extraArgs:
      bind-address: 0.0.0.0

  scheduler:
    extraArgs:
      bind-address: 0.0.0.0

  etcd:
    extraArgs:
      listen-metrics-urls: http://0.0.0.0:2381

  # Inline manifests deployed automatically
  inlineManifests:
    # Namespace for our stack
    - name: intuitive-os-namespace
      contents: |
        apiVersion: v1
        kind: Namespace
        metadata:
          name: intuitive-os
          labels:
            app.kubernetes.io/part-of: intuitive-os
