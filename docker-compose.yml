# Crucible Docker Compose Configuration
#
# This provides a complete Crucible stack with:
# - Crucible MCP Server
# - Persistent data volumes
# - Docker management via socket
# - Access to host appdata directories
#
# Usage:
#   docker-compose up -d     # Start Crucible
#   docker-compose logs -f   # View logs
#   docker-compose down      # Stop Crucible

services:
  crucible:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: crucible
    restart: unless-stopped

    # Volume mounts for Docker access and host filesystem
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Crucible's own data
      - crucible-data:/crucible/data
      - crucible-fixtures:/crucible/fixtures
      - crucible-learnings:/crucible/learnings
      # Host appdata access (adjust paths per deployment)
      - ${APPDATA_PATH:-/mnt/Main/appdata}:/appdata:rw
      # Host mnt access for broader file operations
      - /mnt:/mnt:rw

    # Network for potential HTTP transport
    ports:
      - "8080:8080"

    # Run as root to access docker socket
    # Security: socket access is the main concern, not user
    user: root

    environment:
      - PYTHONUNBUFFERED=1
      - CRUCIBLE_DATA_DIR=/crucible/data
      # Plugin configuration
      - CRUCIBLE_DEVOPS_PATHS=/appdata,/mnt,/tmp

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "from server.main import CrucibleServer; print('ok')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Stdin/stdout for MCP stdio transport
    stdin_open: true
    tty: true

volumes:
  crucible-data:
    name: crucible-data
  crucible-fixtures:
    name: crucible-fixtures
  crucible-learnings:
    name: crucible-learnings
